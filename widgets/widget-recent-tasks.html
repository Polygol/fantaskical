<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recent Tasks</title>
    <script src="/assets/gurapp/api/gurasuraisu-api.js"></script>
    <style>
        :root {
            --text-color: #f9f9f9;
            --secondary-text-color: rgba(255, 255, 255, 0.7);
        }
        body.light-theme {
            --text-color: #333333;
            --secondary-text-color: rgba(0, 0, 0, 0.7);
        }
        body {
            background: transparent; font-family: 'Inter', sans-serif;
            color: var(--text-color); margin: 0; padding: 20px;
            height: 100vh; box-sizing: border-box; overflow: hidden;
        }
        .header {
            font-weight: bold; font-size: 18px; margin-bottom: 10px;
        }
        .task-list {
            font-size: 18px;
            line-height: 31px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .task-item {
            display: flex; align-items: center;
            margin-bottom: 4px;
        }
        .task-bullet {
            margin-right: 8px;
        }
        .task-text {
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .no-tasks { color: var(--secondary-text-color); }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="header" id="widgetHeader"></div>
        <div class="task-list" id="taskList">Loading...</div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const taskList = document.getElementById('taskList');
            const widgetHeader = document.getElementById('widgetHeader');
        
            function updateTasks() {
                try {
                    const allTasks = JSON.parse(localStorage.getItem('tasks')) || [];
                    const allActiveTasks = allTasks.filter(task => !task.completed);
                    
                    // Update header with the total count of active tasks
                    const activeCount = allActiveTasks.length;
                    widgetHeader.textContent = `${activeCount} Active ${activeCount === 1 ? 'Task' : 'Tasks'}`;
        
                    // Get the 4 most recent tasks to display in the list
                    const tasksToDisplay = allActiveTasks
                        .sort((a, b) => b.id - a.id)
                        .slice(0, 4);
        
                    if (tasksToDisplay.length === 0) {
                        taskList.innerHTML = '<div class="no-tasks">All tasks completed</div>';
                    } else {
                        taskList.innerHTML = tasksToDisplay.map(task => `
                            <div class="task-item">
                                <span class="task-bullet">â€¢</span>
                                <div class="task-text">${task.text}</div>
                            </div>
                        `).join('');
                    }
                } catch(e) {
                    taskList.innerHTML = '<div class="no-tasks">Error</div>';
                    widgetHeader.textContent = 'Active Tasks';
                }
            }
        
            window.addEventListener('storage', (event) => {
                if (event.key === 'tasks') {
                    updateTasks();
                }
                if (event.key === 'theme') {
                    document.body.classList.toggle('light-theme', event.newValue === 'light');
                }
            });
        
            updateTasks();
        });
    </script>
</body>
</html>
